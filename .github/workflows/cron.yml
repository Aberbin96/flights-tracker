name: Application Cron Jobs

on:
  schedule:
    # -------------------------------------------------------------
    # SCHEDULE 1: Flight Data Sync API (Multi-provider)
    # Target: 0:00 AM, 8:00 AM, 4:00 PM UTC (3 times a day)
    # Why: Stays under limits for AeroDataBox (600/mo) and AviationStack (500/mo) across 6 airports.
    # -------------------------------------------------------------
    - cron: "0 0,8,16 * * *"

    # -------------------------------------------------------------
    # SCHEDULE 2: Database Cleanup Engine
    # Target: Every hour at minute 30 (e.g., 8:30, 9:30, 10:30)
    # Why: Does not use Aviation API, just cleans up ghosts/stale flights.
    # -------------------------------------------------------------
    - cron: "30 * * * *"

    # -------------------------------------------------------------
    # SCHEDULE 3: Aircraft Enrichment Engine (Hexdb)
    # Target: Every hour at minute 45 (e.g., 8:45, 9:45, 10:45)
    # Why: Resolves unknown registrations for flights with captured ICAO24.
    # -------------------------------------------------------------
    - cron: "45 * * * *"

  # Allow manual triggering from the GitHub Actions tab
  workflow_dispatch:

jobs:
  run-sync:
    name: Run API Sync Job
    runs-on: ubuntu-latest
    environment: Production

    # We only want to run the Sync job natively on the 0,8,16 schedule (or manually)
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 0,8,16 * * *'

    steps:
      - name: Hit /api/sync endpoint for each airport
        run: |
          AIRPORTS=("CCS" "MAR" "VLN" "PMV" "BLA" "PZO")
          for iata in "${AIRPORTS[@]}"; do
            echo "Syncing $iata..."
            curl -X GET "${{ secrets.PROD_URL }}/api/sync?airport=$iata" \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              -f || exit 1
            echo "Waiting to avoid rate-limit..."
            sleep 2
          done

  run-enrichment:
    name: Run Aircraft Enrichment Job
    runs-on: ubuntu-latest
    environment: Production

    # We only want to run the Enrichment job natively on the hourly schedule (or manually)
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '45 * * * *'

    steps:
      - name: Hit /api/enrich-aircraft endpoint
        run: |
          curl -X GET "${{ secrets.PROD_URL }}/api/enrich-aircraft" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -f || exit 1

  run-cleanup:
    name: Run Database Cleanup Job
    runs-on: ubuntu-latest
    environment: Production

    # We only want to run the Cleanup job natively on the hourly schedule (or manually)
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '30 * * * *'

    steps:
      - name: Hit /api/cleanup endpoint
        run: |
          curl -X GET "${{ secrets.PROD_URL }}/api/cleanup" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -f || exit 1
